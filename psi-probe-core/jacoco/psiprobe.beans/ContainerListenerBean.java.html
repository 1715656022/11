<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContainerListenerBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans</a> &gt; <span class="el_source">ContainerListenerBean.java</span></div><h1>ContainerListenerBean.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans;

import com.maxmind.db.CHMCache;
import com.maxmind.geoip2.DatabaseReader;
import com.maxmind.geoip2.exception.AddressNotFoundException;
import com.maxmind.geoip2.model.CountryResponse;
import com.maxmind.geoip2.record.Country;

import java.io.File;
import java.net.InetAddress;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Set;

import javax.inject.Inject;
import javax.management.InstanceNotFoundException;
import javax.management.MBeanServer;
import javax.management.MBeanServerNotification;
import javax.management.Notification;
import javax.management.NotificationListener;
import javax.management.ObjectInstance;
import javax.management.ObjectName;
import javax.management.RuntimeOperationsException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import psiprobe.model.Connector;
import psiprobe.model.RequestProcessor;
import psiprobe.model.ThreadPool;
import psiprobe.model.jmx.ThreadPoolObjectName;
import psiprobe.tools.JmxTools;

/**
 * This class interfaces Tomcat JMX functionality to read connection status. The class essentially
 * provides and maintains the list of connection ThreadPools.
 */
<span class="fc" id="L49">public class ContainerListenerBean implements NotificationListener {</span>

  /** The Constant logger. */
<span class="fc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(ContainerListenerBean.class);</span>

  /** The pool names. */
  private List&lt;ThreadPoolObjectName&gt; poolNames;

  /** The executor names. */
  private List&lt;ObjectName&gt; executorNames;

  /** Used to obtain required {@link MBeanServer} instance. */
  @Inject
  private ContainerWrapperBean containerWrapper;

  /**
   * Gets the container wrapper.
   *
   * @return the container wrapper
   */
  public ContainerWrapperBean getContainerWrapper() {
<span class="fc" id="L70">    return containerWrapper;</span>
  }

  /**
   * Sets the container wrapper.
   *
   * @param containerWrapper the new container wrapper
   */
  public void setContainerWrapper(ContainerWrapperBean containerWrapper) {
<span class="fc" id="L79">    this.containerWrapper = containerWrapper;</span>
<span class="fc" id="L80">  }</span>

  /**
   * Checks if is initialized.
   *
   * @return true, if is initialized
   */
  private boolean isInitialized() {
<span class="nc bnc" id="L88" title="All 4 branches missed.">    return poolNames != null &amp;&amp; !poolNames.isEmpty();</span>
  }

  /**
   * Finds ThreadPoolObjectName by its string name.
   * 
   * @param name - pool name
   * @return null if the input name is null or ThreadPoolObjectName is not found
   */
  private ThreadPoolObjectName findPool(String name) {
<span class="nc bnc" id="L98" title="All 4 branches missed.">    if (name != null &amp;&amp; isInitialized()) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">      for (ThreadPoolObjectName threadPoolObjectName : poolNames) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (name.equals(threadPoolObjectName.getThreadPoolName().getKeyProperty(&quot;name&quot;))) {</span>
<span class="nc" id="L101">          return threadPoolObjectName;</span>
        }
<span class="nc" id="L103">      }</span>
    }
<span class="nc" id="L105">    return null;</span>
  }

  /**
   * Handles creation and deletion of new &quot;worker&quot; threads.
   *
   * @param notification the notification
   * @param object the object
   */
  @Override
  public synchronized void handleNotification(Notification notification, Object object) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">    if (notification instanceof MBeanServerNotification</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        &amp;&amp; notification.getType().equals(MBeanServerNotification.REGISTRATION_NOTIFICATION)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        || notification.getType().equals(MBeanServerNotification.UNREGISTRATION_NOTIFICATION)) {</span>

<span class="nc" id="L120">      ObjectName objectName = ((MBeanServerNotification) notification).getMBeanName();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">      if (&quot;RequestProcessor&quot;.equals(objectName.getKeyProperty(&quot;type&quot;))) {</span>
<span class="nc" id="L122">        ThreadPoolObjectName threadPoolObjectName = findPool(objectName.getKeyProperty(&quot;worker&quot;));</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (threadPoolObjectName != null) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">          if (notification.getType().equals(MBeanServerNotification.REGISTRATION_NOTIFICATION)) {</span>
<span class="nc" id="L125">            threadPoolObjectName.getRequestProcessorNames().add(objectName);</span>
          } else {
<span class="nc" id="L127">            threadPoolObjectName.getRequestProcessorNames().remove(objectName);</span>
          }
        }
      }
    }
<span class="nc" id="L132">  }</span>

  /**
   * Load ObjectNames for the relevant MBeans so they can be queried at a later stage without
   * searching MBean server over and over again.
   *
   * @throws Exception - this method does not handle any of the exceptions that may be thrown when
   *         querying MBean server.
   */
  private synchronized void initialize() throws Exception {

<span class="nc" id="L143">    MBeanServer server = getContainerWrapper().getResourceResolver().getMBeanServer();</span>
<span class="nc" id="L144">    String serverName = getContainerWrapper().getTomcatContainer().getName();</span>
<span class="nc" id="L145">    Set&lt;ObjectInstance&gt; threadPools =</span>
<span class="nc" id="L146">        server.queryMBeans(new ObjectName(serverName + &quot;:type=ThreadPool,*&quot;), null);</span>
<span class="nc" id="L147">    poolNames = new ArrayList&lt;&gt;(threadPools.size());</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">    for (ObjectInstance threadPool : threadPools) {</span>

<span class="nc" id="L150">      ThreadPoolObjectName threadPoolObjectName = new ThreadPoolObjectName();</span>
<span class="nc" id="L151">      ObjectName threadPoolName = threadPool.getObjectName();</span>

<span class="nc" id="L153">      String name = threadPoolName.getKeyProperty(&quot;name&quot;);</span>

<span class="nc" id="L155">      threadPoolObjectName.setThreadPoolName(threadPoolName);</span>
<span class="nc" id="L156">      ObjectName grpName = server</span>
<span class="nc" id="L157">          .getObjectInstance(new ObjectName(</span>
<span class="nc" id="L158">              threadPoolName.getDomain() + &quot;:type=GlobalRequestProcessor,name=&quot; + name))</span>
<span class="nc" id="L159">          .getObjectName();</span>
<span class="nc" id="L160">      threadPoolObjectName.setGlobalRequestProcessorName(grpName);</span>

      /*
       * unfortunately exact workers could not be found at the time of testing so we filter out the
       * relevant workers within the loop
       */
<span class="nc" id="L166">      Set&lt;ObjectInstance&gt; workers = server.queryMBeans(</span>
<span class="nc" id="L167">          new ObjectName(threadPoolName.getDomain() + &quot;:type=RequestProcessor,*&quot;), null);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">      for (ObjectInstance worker : workers) {</span>
<span class="nc" id="L170">        ObjectName wrkName = worker.getObjectName();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (name.equals(wrkName.getKeyProperty(&quot;worker&quot;))) {</span>
<span class="nc" id="L172">          threadPoolObjectName.getRequestProcessorNames().add(wrkName);</span>
        }
<span class="nc" id="L174">      }</span>

<span class="nc" id="L176">      poolNames.add(threadPoolObjectName);</span>
<span class="nc" id="L177">    }</span>

<span class="nc" id="L179">    Set&lt;ObjectInstance&gt; executors =</span>
<span class="nc" id="L180">        server.queryMBeans(new ObjectName(serverName + &quot;:type=Executor,*&quot;), null);</span>
<span class="nc" id="L181">    executorNames = new ArrayList&lt;&gt;(executors.size());</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">    for (ObjectInstance executor : executors) {</span>
<span class="nc" id="L183">      ObjectName executorName = executor.getObjectName();</span>
<span class="nc" id="L184">      executorNames.add(executorName);</span>
<span class="nc" id="L185">    }</span>

    // Register with MBean server
<span class="nc" id="L188">    server.addNotificationListener(new ObjectName(&quot;JMImplementation:type=MBeanServerDelegate&quot;),</span>
        this, null, null);

<span class="nc" id="L191">  }</span>

  /**
   * Gets the thread pools.
   *
   * @return the thread pools
   * @throws Exception the exception
   */
  public synchronized List&lt;ThreadPool&gt; getThreadPools() throws Exception {
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (!isInitialized()) {</span>
<span class="nc" id="L201">      initialize();</span>
    }

<span class="nc" id="L204">    List&lt;ThreadPool&gt; threadPools = new ArrayList&lt;&gt;(poolNames.size());</span>

<span class="nc" id="L206">    MBeanServer server = getContainerWrapper().getResourceResolver().getMBeanServer();</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">    for (ObjectName executorName : executorNames) {</span>
<span class="nc" id="L209">      ThreadPool threadPool = new ThreadPool();</span>
<span class="nc" id="L210">      threadPool.setName(executorName.getKeyProperty(&quot;name&quot;));</span>
<span class="nc" id="L211">      threadPool.setMaxThreads(JmxTools.getIntAttr(server, executorName, &quot;maxThreads&quot;));</span>
<span class="nc" id="L212">      threadPool.setMaxSpareThreads(JmxTools.getIntAttr(server, executorName, &quot;largestPoolSize&quot;));</span>
<span class="nc" id="L213">      threadPool.setMinSpareThreads(JmxTools.getIntAttr(server, executorName, &quot;minSpareThreads&quot;));</span>
<span class="nc" id="L214">      threadPool.setCurrentThreadsBusy(JmxTools.getIntAttr(server, executorName, &quot;activeCount&quot;));</span>
<span class="nc" id="L215">      threadPool.setCurrentThreadCount(JmxTools.getIntAttr(server, executorName, &quot;poolSize&quot;));</span>
<span class="nc" id="L216">      threadPools.add(threadPool);</span>
<span class="nc" id="L217">    }</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">    for (ThreadPoolObjectName threadPoolObjectName : poolNames) {</span>
      try {
<span class="nc" id="L221">        ObjectName poolName = threadPoolObjectName.getThreadPoolName();</span>

<span class="nc" id="L223">        ThreadPool threadPool = new ThreadPool();</span>
<span class="nc" id="L224">        threadPool.setName(poolName.getKeyProperty(&quot;name&quot;));</span>
<span class="nc" id="L225">        threadPool.setMaxThreads(JmxTools.getIntAttr(server, poolName, &quot;maxThreads&quot;));</span>

<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (JmxTools.hasAttribute(server, poolName, &quot;maxSpareThreads&quot;)) {</span>
<span class="nc" id="L228">          threadPool.setMaxSpareThreads(JmxTools.getIntAttr(server, poolName, &quot;maxSpareThreads&quot;));</span>
<span class="nc" id="L229">          threadPool.setMinSpareThreads(JmxTools.getIntAttr(server, poolName, &quot;minSpareThreads&quot;));</span>
        }

<span class="nc" id="L232">        threadPool</span>
<span class="nc" id="L233">            .setCurrentThreadsBusy(JmxTools.getIntAttr(server, poolName, &quot;currentThreadsBusy&quot;));</span>
<span class="nc" id="L234">        threadPool</span>
<span class="nc" id="L235">            .setCurrentThreadCount(JmxTools.getIntAttr(server, poolName, &quot;currentThreadCount&quot;));</span>

        /*
         * Tomcat will return -1 for maxThreads if the connector uses an executor for its
         * threads. In this case, don't add its ThreadPool to the results.
         */
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (threadPool.getMaxThreads() &gt; -1) {</span>
<span class="nc" id="L242">          threadPools.add(threadPool);</span>
        }
<span class="nc" id="L244">      } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L245">        logger.error(&quot;Failed to query entire thread pool {}&quot;, threadPoolObjectName);</span>
<span class="nc" id="L246">        logger.debug(&quot;&quot;, e);</span>
<span class="nc" id="L247">      }</span>
<span class="nc" id="L248">    }</span>
<span class="nc" id="L249">    return threadPools;</span>
  }

  /**
   * Gets the connectors.
   *
   * @param includeRequestProcessors the include request processors
   * @return the connectors
   * @throws Exception the exception
   */
  public synchronized List&lt;Connector&gt; getConnectors(boolean includeRequestProcessors)
      throws Exception {

<span class="nc" id="L262">    boolean workerThreadNameSupported = true;</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">    if (!isInitialized()) {</span>
<span class="nc" id="L265">      initialize();</span>
    }

<span class="nc" id="L268">    List&lt;Connector&gt; connectors = new ArrayList&lt;&gt;(poolNames.size());</span>

<span class="nc" id="L270">    MBeanServer server = getContainerWrapper().getResourceResolver().getMBeanServer();</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">    for (ThreadPoolObjectName threadPoolObjectName : poolNames) {</span>
      try {
<span class="nc" id="L274">        ObjectName poolName = threadPoolObjectName.getThreadPoolName();</span>

<span class="nc" id="L276">        Connector connector = new Connector();</span>
<span class="nc" id="L277">        connector.setProtocolHandler(poolName.getKeyProperty(&quot;name&quot;));</span>

<span class="nc" id="L279">        ObjectName grpName = threadPoolObjectName.getGlobalRequestProcessorName();</span>

<span class="nc" id="L281">        connector.setMaxTime(JmxTools.getLongAttr(server, grpName, &quot;maxTime&quot;));</span>
<span class="nc" id="L282">        connector.setProcessingTime(JmxTools.getLongAttr(server, grpName, &quot;processingTime&quot;));</span>
<span class="nc" id="L283">        connector.setBytesReceived(JmxTools.getLongAttr(server, grpName, &quot;bytesReceived&quot;));</span>
<span class="nc" id="L284">        connector.setBytesSent(JmxTools.getLongAttr(server, grpName, &quot;bytesSent&quot;));</span>
<span class="nc" id="L285">        connector.setRequestCount(JmxTools.getIntAttr(server, grpName, &quot;requestCount&quot;));</span>
<span class="nc" id="L286">        connector.setErrorCount(JmxTools.getIntAttr(server, grpName, &quot;errorCount&quot;));</span>

<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (includeRequestProcessors) {</span>
<span class="nc" id="L289">          List&lt;ObjectName&gt; wrkNames = threadPoolObjectName.getRequestProcessorNames();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">          for (ObjectName wrkName : wrkNames) {</span>
            try {
<span class="nc" id="L292">              RequestProcessor rp = new RequestProcessor();</span>
<span class="nc" id="L293">              rp.setName(wrkName.getKeyProperty(&quot;name&quot;));</span>
<span class="nc" id="L294">              rp.setStage(JmxTools.getIntAttr(server, wrkName, &quot;stage&quot;));</span>
<span class="nc" id="L295">              rp.setProcessingTime(JmxTools.getLongAttr(server, wrkName, &quot;requestProcessingTime&quot;));</span>
<span class="nc" id="L296">              rp.setBytesSent(JmxTools.getLongAttr(server, wrkName, &quot;requestBytesSent&quot;));</span>
<span class="nc" id="L297">              rp.setBytesReceived(JmxTools.getLongAttr(server, wrkName, &quot;requestBytesReceived&quot;));</span>
              try {
<span class="nc" id="L299">                rp.setRemoteAddr(JmxTools.getStringAttr(server, wrkName, &quot;remoteAddr&quot;));</span>
<span class="nc" id="L300">              } catch (RuntimeOperationsException ex) {</span>
<span class="nc" id="L301">                logger.trace(&quot;&quot;, ex);</span>
<span class="nc" id="L302">              }</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">              if (rp.getRemoteAddr() != null) {</span>
                // Show flag as defined in jvm for localhost
<span class="nc bnc" id="L306" title="All 2 branches missed.">                if (InetAddress.getByName(rp.getRemoteAddr()).isLoopbackAddress()) {</span>
<span class="nc" id="L307">                  rp.setRemoteAddrLocale(new Locale(System.getProperty(&quot;user.language&quot;),</span>
<span class="nc" id="L308">                      System.getProperty(&quot;user.country&quot;)));</span>
                } else {
                  // Show flag for non-localhost using geo lite
<span class="nc" id="L311">                  try (DatabaseReader reader = new DatabaseReader.Builder(new File(</span>
<span class="nc" id="L312">                      getClass().getClassLoader().getResource(&quot;GeoLite2-Country.mmdb&quot;).toURI()))</span>
<span class="nc" id="L313">                          .withCache(new CHMCache()).build()) {</span>
<span class="nc" id="L314">                    CountryResponse response =</span>
<span class="nc" id="L315">                        reader.country(InetAddress.getByName(rp.getRemoteAddr()));</span>
<span class="nc" id="L316">                    Country country = response.getCountry();</span>
<span class="nc" id="L317">                    rp.setRemoteAddrLocale(new Locale(&quot;&quot;, country.getIsoCode()));</span>
<span class="nc bnc" id="L318" title="All 8 branches missed.">                  } catch (AddressNotFoundException e) {</span>
<span class="nc" id="L319">                    logger.debug(&quot;{}&quot;, e.getMessage());</span>
<span class="nc" id="L320">                    logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L321">                  }</span>
                }
              }

<span class="nc" id="L325">              rp.setVirtualHost(JmxTools.getStringAttr(server, wrkName, &quot;virtualHost&quot;));</span>
<span class="nc" id="L326">              rp.setMethod(JmxTools.getStringAttr(server, wrkName, &quot;method&quot;));</span>
<span class="nc" id="L327">              rp.setCurrentUri(JmxTools.getStringAttr(server, wrkName, &quot;currentUri&quot;));</span>
<span class="nc" id="L328">              rp.setCurrentQueryString(</span>
<span class="nc" id="L329">                  JmxTools.getStringAttr(server, wrkName, &quot;currentQueryString&quot;));</span>
<span class="nc" id="L330">              rp.setProtocol(JmxTools.getStringAttr(server, wrkName, &quot;protocol&quot;));</span>

              // Relies on https://issues.apache.org/bugzilla/show_bug.cgi?id=41128
<span class="nc bnc" id="L333" title="All 2 branches missed.">              if (workerThreadNameSupported</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                  &amp;&amp; JmxTools.hasAttribute(server, wrkName, &quot;workerThreadName&quot;)) {</span>

<span class="nc" id="L336">                rp.setWorkerThreadName(JmxTools.getStringAttr(server, wrkName, &quot;workerThreadName&quot;));</span>
<span class="nc" id="L337">                rp.setWorkerThreadNameSupported(true);</span>
              } else {
                /*
                 * attribute should consistently either exist or be missing across all the workers
                 * so it does not make sense to check attribute existence if we have found once that
                 * it is not supported
                 */
<span class="nc" id="L344">                rp.setWorkerThreadNameSupported(false);</span>
<span class="nc" id="L345">                workerThreadNameSupported = false;</span>
              }
<span class="nc" id="L347">              connector.addRequestProcessor(rp);</span>
<span class="nc" id="L348">            } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L349">              logger.info(&quot;Failed to query RequestProcessor {}&quot;, wrkName);</span>
<span class="nc" id="L350">              logger.debug(&quot;&quot;, e);</span>
<span class="nc" id="L351">            }</span>
<span class="nc" id="L352">          }</span>
        }

<span class="nc" id="L355">        connectors.add(connector);</span>
<span class="nc" id="L356">      } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L357">        logger.error(&quot;Failed to query entire thread pool {}&quot;, threadPoolObjectName);</span>
<span class="nc" id="L358">        logger.debug(&quot;  Stack trace:&quot;, e);</span>
<span class="nc" id="L359">      }</span>
<span class="nc" id="L360">    }</span>
<span class="nc" id="L361">    return connectors;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>